---
- name: install consul
  hosts: consul_servers
  become: yes
  vars:
    consul_config_options:
      enable_local_script_checks: true
      leave_on_terminate: true
      rejoin_after_leave: true
      log_level: INFO
      log_rotate_max_files: 7
      ui: true
      dns_config:
        enable_truncate: true
        only_passing: true
      ports:
        https: 8501
      acl:
        enabled: true
        enable_token_persistence: true
        default_policy: deny
      connect:
        enabled: true
      ca_file: '{{ consul_certs_path }}/{{ consul_domain }}-agent-ca.pem'
      cert_file: '{{ consul_certs_path }}/{{ consul_datacenter }}-server-{{ consul_domain }}-0.pem'
      key_file: '{{ consul_certs_path }}/{{ consul_datacenter }}-server-{{ consul_domain }}-0-key.pem'
      verify_incoming: true
      verify_outgoing: true
      verify_incoming_rpc: true
      verify_server_hostname: true
      encrypt: KVEWESv8Odqmlrn3BXMkHMnrFhkTEtIXk+ZXYqYvzYY=
      auto_encrypt:
        allow_tls: true
    consul_acl_policies:
      - name: vault_policy
        description: Policy for Vault access
        rules:
          - resource: key_prefix
            segment: vault/
            policy: write
          - resource: node_prefix
            segment: ""
            policy: write
          - resource: service
            segment: vault
            policy: write
          - resource: agent_prefix
            segment: ""
            policy: write
          - resource: session_prefix
            segment: ""
            policy: write
      - name: consul_agent_policy
        description: Policy for Consul agent node
        rules:
          - resource: agent_prefix
            segment: ""
            policy: write
          - resource: node_prefix
            segment: ""
            policy: write
          - resource: service_prefix
            segment: ""
            policy: read
          - resource: session_prefix
            segment: ""
            policy: read
    consul_acl_tokens:
      - secret: cc542a4d-3207-44a4-9d73-c0ac840439e9
        description: Token for Vault access
        policy_name:
          - vault_policy
      - secret: 87106a90-47e3-43eb-b1ca-86eec7ca1497
        description: Token for Consul agent
        policy_name:
          - consul_agent_policy
  roles: 
    - consul
  post_tasks:
    - name: get consul ca certificate
      fetch:
        src: '{{ consul_certs_path }}/{{ consul_domain }}-agent-ca.pem'
        dest: /tmp/{{ consul_domain }}-agent-ca.pem
        flat: yes
      run_once: yes

- name: install vault
  hosts: vault_servers
  become: yes
  vars:
    vault_config_options:
      ui: true
      listener:
        - tcp:
            address: 0.0.0.0:{{ vault_port }}
            cluster_address: '{{ ansible_host}}:{{ vault_cluster_port }}'
            tls_disable: true
      storage:
        consul:
          address: 192.168.1.40:8500
          token: cc542a4d-3207-44a4-9d73-c0ac840439e9
      api_addr: http://{{ ansible_host}}:{{ vault_port }}
      cluster_addr: 'https://{{ ansible_host }}:{{ vault_cluster_port }}'
      log_level: info
      log_format: standard
      pid_file: '{{ vault_run_path }}/vault.pid'
    consul_config_options:
      leave_on_terminate: true
      rejoin_after_leave: true
      log_level: INFO
      log_rotate_max_files: 7
      acl:
        enabled: true
        enable_token_persistence: true
        default_policy: deny
        tokens:
          agent: 87106a90-47e3-43eb-b1ca-86eec7ca1497
      auto_encrypt:
        tls: true
      ca_file: '{{ consul_certs_path }}/{{ consul_domain }}-agent-ca.pem'
      verify_incoming: true
      verify_outgoing: true
      verify_incoming_rpc: true
      verify_server_hostname: true
      encrypt: KVEWESv8Odqmlrn3BXMkHMnrFhkTEtIXk+ZXYqYvzYY=
      start_join:
        - 192.168.1.40
        - 192.168.1.41
        - 192.168.1.43
      retry_join:
        - 192.168.1.40
        - 192.168.1.41
        - 192.168.1.43        
    consul_agent_mode: client
  roles: 
    - consul
    - vault
  post_tasks:
    - name: create consul tls directory
      file:
        path: '{{ consul_certs_path }}'
        state: directory
        owner: '{{ consul_user }}'
        group: '{{ consul_group }}'
        mode: 0700

    - name: copy consul ca certificate to vault servers
      copy:
        src: /tmp/{{ consul_domain }}-agent-ca.pem
        dest: '{{ consul_certs_path }}/{{ consul_domain }}-agent-ca.pem'
        owner: '{{ consul_user }}'
        group: '{{ consul_group }}'
        mode: '0644'
      notify: restart consul
