---
driver:
  name: vagrant

provisioner:
  name: shell

platforms:
  - name: centos/8

suites:
  - name: vault1
    provisioner:
      command: |-
        sudo grep -w "PasswordAuthentication no" /etc/ssh/sshd_config > \
        /dev/null 2>&1
        if [ $? -eq 0 ]; then
            sudo sed -i "s/PasswordAuthentication no/PasswordAuthentication \
            yes/g" /etc/ssh/sshd_config
            sudo systemctl reload sshd
        fi
    driver_config:
      vm_hostname: vault1.cluster.local
      network:
        - ["private_network", {ip: "192.168.1.11"}]
      customize:
        memory: 1024
  - name: vault2
    provisioner:
      command: |-
        sudo grep -w "PasswordAuthentication no" /etc/ssh/sshd_config > \
        /dev/null 2>&1
        if [ $? -eq 0 ]; then
            sudo sed -i "s/PasswordAuthentication no/PasswordAuthentication \
            yes/g" /etc/ssh/sshd_config
            sudo systemctl reload sshd
        fi
    driver_config:
      vm_hostname: vault2.cluster.local
      network:
        - ["private_network", {ip: "192.168.2.11"}]
      customize:
        memory: 1024
  - name: vault3
    provisioner:
      command: |-
        sudo grep -w "PasswordAuthentication no" /etc/ssh/sshd_config > \
        /dev/null 2>&1
        if [ $? -eq 0 ]; then
            sudo sed -i "s/PasswordAuthentication no/PasswordAuthentication \
            yes/g" /etc/ssh/sshd_config
            sudo systemctl reload sshd
        fi
    driver_config:
      vm_hostname: vault3.cluster.local
      network:
        - ["private_network", {ip: "192.168.3.11"}]
      customize:
        memory: 1024
  - name: haproxy1
    provisioner:
      command: >
        sudo sed -i "s/PasswordAuthentication no/PasswordAuthentication yes/g" /etc/ssh/sshd_config && sudo systemctl restart sshd
    driver_config:
      vm_hostname: haproxy1.cluster.local
      network:
        - ["private_network", {ip: "192.168.1.250"}]
        - ["private_network", {ip: "192.168.3.204"}]
  - name: haproxy2
    provisioner:
      command: >
        sudo sed -i "s/PasswordAuthentication no/PasswordAuthentication yes/g" /etc/ssh/sshd_config && sudo systemctl restart sshd
    driver_config:
      vm_hostname: haproxy2.cluster.local
      network:
        - ["private_network", {ip: "192.168.2.250"}]
        - ["private_network", {ip: "192.168.3.205"}]
  - name: ansible
    provisioner:
      name: ansible_playbook
      roles_path: .
      ansible_inventory: hosts
      playbook: playbooks/vault-cluster.yml
      ansible_playbook_command: >-
        ansible-playbook -e "ansible_user=vagrant ansible_password=vagrant"
        --ssh-extra-args="-o ConnectTimeout=10 -o ConnectionAttempts=60 
        -o StrictHostKeyChecking=no" -i /tmp/kitchen/hosts 
        /tmp/kitchen/vault-cluster.yml
      require_chef_for_busser: false
      max_retries: 5
    driver_config:
      vm_hostname: ansible.cluster.local
      network:
        - ["private_network", {ip: "192.168.1.254"}]
